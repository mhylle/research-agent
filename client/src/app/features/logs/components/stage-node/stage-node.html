<div class="stage-node"
     [style.--stage-color]="node.color"
     [class.stage-node--regeneration]="node.type === 'plan_regeneration'"
     [class.stage-node--warning]="node.type === 'plan_evaluation_warning'">
  <div class="stage-node__header" (click)="toggleExpand()">
    <div class="stage-node__title">
      <span class="stage-node__icon">{{ node.icon }}</span>
      <span class="stage-node__name">{{ node.name }}</span>
      <span class="status-badge" [class]="'status-' + node.status" *ngIf="node.status">
        {{ node.status }}
      </span>
      <!-- Show attempt number for regeneration nodes -->
      <span class="attempt-badge" *ngIf="node.type === 'plan_regeneration' && node.metadata && node.metadata.attemptNumber">
        Attempt {{ node.metadata.attemptNumber }}
      </span>
    </div>
    <div class="stage-node__meta">
      <span class="stage-node__duration" *ngIf="node.duration > 0">{{ formatDuration(node.duration) }}</span>
      <span class="stage-node__expand-icon" [class.stage-node__expand-icon--expanded]="node.isExpanded">
        ‚ñ∂
      </span>
    </div>
  </div>

  <div class="stage-node__content" *ngIf="node.isExpanded">
    <!-- Plan Regeneration specific content -->
    <div class="regeneration-section" *ngIf="node.type === 'plan_regeneration'">
      <h4 class="regeneration-title">üîÑ Plan Regeneration Feedback</h4>

      <!-- Failing Dimensions -->
      <div class="failing-dimensions" *ngIf="node.metadata && node.metadata.failingDimensions && node.metadata.failingDimensions.length > 0">
        <h5>Failing Evaluation Dimensions:</h5>
        <div class="dimension-list">
          <div class="dimension-item" *ngFor="let dimensionName of node.metadata.failingDimensions">
            <span class="dimension-name">{{ dimensionName }}</span>
            <span class="dimension-score" [class.score-fail]="node.metadata.previousScores && node.metadata.previousScores[dimensionName] < 0.7">
              Score: {{ node.metadata.previousScores && node.metadata.previousScores[dimensionName] !== undefined ? (node.metadata.previousScores[dimensionName] | number:'1.2-2') : 'N/A' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Previous Scores -->
      <div class="previous-scores" *ngIf="node.metadata && node.metadata.previousScores">
        <h5>Previous Evaluation Scores:</h5>
        <app-json-viewer title="" [data]="node.metadata.previousScores" />
      </div>

      <!-- Critique -->
      <div class="critique-section" *ngIf="node.metadata && node.metadata.critique">
        <h5>Evaluation Critique:</h5>
        <div class="critique-content">{{ node.metadata.critique }}</div>
      </div>
    </div>

    <!-- Plan Evaluation Warning specific content -->
    <div class="warning-section" *ngIf="node.type === 'plan_evaluation_warning'">
      <h4 class="warning-title">‚ö†Ô∏è Plan Evaluation Warning</h4>
      <div class="warning-message" *ngIf="node.output && node.output.message">{{ node.output.message }}</div>

      <div class="final-scores" *ngIf="node.metadata && node.metadata.finalScores">
        <h5>Final Scores:</h5>
        <app-json-viewer title="" [data]="node.metadata.finalScores" />
      </div>
    </div>

    <!-- Standard error section -->
    <div class="error-section" *ngIf="node.error && node.type !== 'plan_regeneration' && node.type !== 'plan_evaluation_warning'">
      <h4 class="error-title">‚ùå Error</h4>
      <div class="error-message">{{ node.error.message }}</div>
      <div class="error-details" *ngIf="node.error.details">
        <app-json-viewer title="Error Details" [data]="node.error.details" />
      </div>
    </div>

    <!-- Standard metadata section -->
    <div class="metadata-section" *ngIf="node.metadata && node.type !== 'plan_regeneration' && node.type !== 'plan_evaluation_warning'">
      <div class="metadata-badge" *ngIf="node.metadata.isAutoAdded">ü§ñ Auto-Added</div>
      <div class="metadata-badge abandoned" *ngIf="node.metadata.isAbandoned">‚ö†Ô∏è Abandoned</div>
      <div class="metadata-badge" *ngIf="node.metadata.recoveryReason">
        üîß Recovery: {{ node.metadata.recoveryReason }}
      </div>
    </div>

    <!-- Standard I/O section (skip for regeneration/warning nodes) -->
    <div class="stage-node__io" *ngIf="node.type !== 'plan_regeneration' && node.type !== 'plan_evaluation_warning'">
      <app-json-viewer title="Input" [data]="node.input" />
      <app-json-viewer title="Output" [data]="node.output" />
    </div>

    <div class="stage-node__milestones" *ngIf="node.milestones && node.milestones.length > 0">
      <h4 class="stage-node__children-title">Milestones ({{ node.milestones.length }})</h4>
      <app-tool-node
        *ngFor="let milestone of node.milestones"
        [node]="milestone"
      />
    </div>

    <div class="stage-node__children" *ngIf="node.children && node.children.length > 0">
      <h4 class="stage-node__children-title">Tool Calls ({{ node.children.length }})</h4>
      <app-tool-node
        *ngFor="let tool of node.children"
        [node]="tool"
      />
    </div>
  </div>

  <div class="stage-node__connector" *ngIf="!isLast"></div>
</div>
