<div
  class="task-card"
  [ngClass]="getStatusClass()"
  [attr.aria-label]="'Task: ' + task().description"
  role="article"
>
  <!-- Status Icon -->
  <div class="task-card__icon" [attr.aria-label]="'Status: ' + task().status">
    {{ getStatusIcon() }}
  </div>

  <!-- Task Content -->
  <div class="task-card__content">
    <!-- Task Description -->
    <div class="task-card__description">
      {{ task().description }}
    </div>

    <!-- Progress Bar (only for running, retrying, or completed tasks) -->
    <div class="task-card__progress" *ngIf="shouldShowProgress()">
      <div class="progress-bar" [ngClass]="getProgressBarClass()">
        <div
          class="progress-fill"
          [style.transform]="'scaleX(' + (task().progress / 100) + ')'"
          [attr.aria-valuenow]="getProgressPercentage()"
          aria-valuemin="0"
          aria-valuemax="100"
          role="progressbar"
        ></div>
      </div>
      <span class="progress-percentage" aria-live="polite">
        {{ getProgressPercentage() }}%
      </span>
    </div>

    <!-- Metadata Row -->
    <div class="task-card__meta">
      <span class="task-card__timestamp">
        {{ formatTimestamp(task().timestamp) }}
      </span>

      <span class="task-card__duration" *ngIf="task().duration !== undefined">
        {{ formatDuration(task().duration) }}
      </span>

      <span class="task-card__stage">Stage {{ task().stage }}</span>

      <!-- Retry Count (if retried) -->
      <span class="task-card__retry-count" *ngIf="task().retryCount > 0">
        Retry {{ task().retryCount }}
      </span>

      <!-- Token usage (if available) -->
      @if (task().tokensUsed) {
        <span class="task-card__tokens">
          {{ task().tokensUsed?.total }} tokens
        </span>
      }
    </div>

    <!-- NEW: Input/Output Details Toggle -->
    @if (hasDetails()) {
      <button
        type="button"
        class="task-card__details-toggle"
        (click)="toggleDetails()"
        [attr.aria-expanded]="showDetails()"
        aria-controls="task-details"
      >
        <span class="toggle-icon" aria-hidden="true">{{ showDetails() ? '‚ñº' : '‚ñ∂' }}</span>
        <span class="toggle-text">
          {{ showDetails() ? 'Hide' : 'Show' }} Details
        </span>
        @if (!showDetails()) {
          <span class="details-preview">
            @if (task().input) {
              <span class="preview-badge preview-badge--input">Input: {{ getInputPreview() }}</span>
            }
            @if (task().output) {
              <span class="preview-badge preview-badge--output">Output: {{ getOutputPreview() }}</span>
            }
          </span>
        }
      </button>

      <!-- Expandable Details Section -->
      @if (showDetails()) {
        <div
          id="task-details"
          class="task-card__details"
          role="region"
          aria-label="Task input and output details"
        >
          <!-- Input Section -->
          @if (task().input) {
            <div class="details-section details-section--input">
              <h4 class="details-section__heading">
                <span class="details-icon">üì•</span>
                Input
              </h4>
              <pre class="details-section__content"><code>{{ formatJson(task().input) }}</code></pre>
            </div>
          }

          <!-- Output Section -->
          @if (task().output) {
            <div class="details-section details-section--output">
              <h4 class="details-section__heading">
                <span class="details-icon">üì§</span>
                Output
              </h4>
              <pre class="details-section__content"><code>{{ formatJson(task().output) }}</code></pre>
            </div>
          }

          <!-- Metadata Section (if available) -->
          @if (task().metadata) {
            <div class="details-section details-section--metadata">
              <h4 class="details-section__heading">
                <span class="details-icon">‚ÑπÔ∏è</span>
                Metadata
              </h4>
              <pre class="details-section__content"><code>{{ formatJson(task().metadata) }}</code></pre>
            </div>
          }
        </div>
      }
    }

    <!-- Error Message (if error exists) -->
    <div class="task-card__error" *ngIf="task().error">
      <span class="task-card__error-icon">‚ö†Ô∏è</span>
      <span class="task-card__error-message">
        {{ task().error?.message }}
      </span>
    </div>
  </div>

  <!-- Retry Button (only for error state with canRetry) -->
  <button
    *ngIf="task().status === 'error' && task().canRetry"
    type="button"
    class="task-card__retry-button"
    (click)="onRetryClick()"
    aria-label="Retry task"
  >
    <span class="retry-icon">‚Üª</span>
    Retry
  </button>
</div>
