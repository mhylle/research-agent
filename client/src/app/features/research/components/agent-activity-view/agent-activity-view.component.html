<div class="agent-activity-view" role="main" aria-label="Agent Activity View">
  <!-- Loading State (only show when not connected, no error, and not complete) -->
  @if (!isConnected() && !connectionError() && !isComplete()) {
    <div class="agent-activity-view__loading" role="status" aria-live="polite">
      <div class="loading-spinner"></div>
      <p class="loading-text">Connecting to research agent...</p>
    </div>
  }

  <!-- Connection Error Banner -->
  @if (connectionError()) {
    <div
      class="agent-activity-view__error-banner"
      role="alert"
      aria-live="assertive"
    >
      <span class="error-icon">‚ö†Ô∏è</span>
      <span class="error-message">{{ connectionError() }}</span>
      <button
        type="button"
        class="error-retry-button"
        (click)="retryConnection()"
        aria-label="Retry connection"
      >
        Retry Connection
      </button>
    </div>
  }

  <!-- Main Content (shown when connected or complete) -->
  @if (isConnected() || isComplete()) {
    <div class="agent-activity-view__content">
      <!-- Stage Progress Header -->
      <app-stage-progress-header
        [stage]="currentStage()"
        [totalPhases]="totalPhases()"
        [phaseName]="currentPhaseName()"
        [progress]="stageProgress()"
        aria-label="Research stage progress"
      />

      <!-- Planning Phase Indicator -->
      @if (isPlanning()) {
        <div class="planning-indicator" role="status" aria-live="polite">
          <div class="planning-indicator__content">
            <span class="planning-spinner"></span>
            <span class="planning-text">
              ü§î Planning research strategy...
              @if (planningIteration()) {
                <span class="planning-iteration">
                  (Iteration {{ planningIteration()?.current }}/{{ planningIteration()?.max }})
                </span>
              }
            </span>
          </div>
        </div>
      }

      <!-- Planned Phases Section (shown after plan is created) -->
      @if (plannedPhases().length > 0) {
        <section class="planned-phases-section" aria-labelledby="planned-phases-heading">
          <button
            type="button"
            class="section-heading section-heading--collapsible"
            (click)="togglePlannedPhases()"
            [attr.aria-expanded]="showPlannedPhases()"
            aria-controls="planned-phases-list"
          >
            <span class="chevron-icon" aria-hidden="true">{{ showPlannedPhases() ? '‚ñº' : '‚ñ∂' }}</span>
            <h3 id="planned-phases-heading">
              üìã Research Plan
              <span class="task-count">({{ plannedPhases().length }} phases)</span>
            </h3>
          </button>

          @if (showPlannedPhases()) {
            <div id="planned-phases-list" class="planned-phases-list">
              @for (phase of plannedPhases(); track phase.id) {
                <div class="planned-phase">
                  <div class="planned-phase__header">
                    <span class="planned-phase__order">{{ phase.order + 1 }}</span>
                    <div class="planned-phase__info">
                      <span class="planned-phase__name">{{ phase.name }}</span>
                      <span class="planned-phase__description">{{ phase.description }}</span>
                    </div>
                    @if (phase.replanCheckpoint) {
                      <span class="planned-phase__checkpoint" title="Re-plan checkpoint">üîÑ</span>
                    }
                  </div>
                  <div class="planned-phase__steps">
                    @for (step of phase.steps; track step.id) {
                      <div class="planned-step">
                        <span class="planned-step__tool">{{ step.toolName }}</span>
                        <span class="planned-step__status" [attr.data-status]="step.status">
                          {{ step.status }}
                        </span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </section>
      }

      <!-- Tasks Container (scrollable) -->
      <div
        #tasksContainer
        class="agent-activity-view__tasks-container"
        role="region"
        aria-label="Task list"
      >
        <!-- Active Tasks Section -->
        <section class="tasks-section" aria-labelledby="active-tasks-heading">
          <h3
            id="active-tasks-heading"
            class="section-heading"
          >
            Active Tasks
            @if (activeTasks().length > 0) {
              <span class="task-count">({{ activeTasks().length }})</span>
            }
          </h3>

          <!-- Active Tasks List -->
          @if (activeTasks().length > 0) {
            <div
              class="tasks-list"
              role="list"
              aria-live="polite"
              aria-atomic="false"
            >
              @for (task of activeTasks(); track trackByTaskId($index, task)) {
                <app-task-card
                  [task]="task"
                  (retry)="handleRetry($event)"
                  role="listitem"
                />
              }
            </div>
          } @else {
            <p class="empty-state" aria-live="polite">
              Waiting for tasks...
            </p>
          }
        </section>

        <!-- Completed Tasks Section (Collapsible) -->
        @if (completedTasks().length > 0) {
          <section
            class="tasks-section tasks-section--completed"
            aria-labelledby="completed-tasks-heading"
          >
            <button
              type="button"
              class="section-heading section-heading--collapsible"
              (click)="toggleCompletedTasks()"
              [attr.aria-expanded]="showCompletedTasks()"
              aria-controls="completed-tasks-list"
            >
              <span class="chevron-icon" aria-hidden="true">{{ getChevronIcon() }}</span>
              <h3 id="completed-tasks-heading">
                Completed Tasks
                <span class="task-count">({{ completedTasks().length }})</span>
              </h3>
            </button>

            <!-- Completed Tasks List (Collapsible Content) -->
            @if (showCompletedTasks()) {
              <div
                id="completed-tasks-list"
                class="tasks-list tasks-list--collapsed"
                role="list"
              >
                @for (task of completedTasks(); track trackByTaskId($index, task)) {
                  <app-task-card
                    [task]="task"
                    (retry)="handleRetry($event)"
                    role="listitem"
                  />
                }
              </div>
            }
          </section>
        }
      </div>

      <!-- Answer Section (shown when research is complete) -->
      @if (isComplete()) {
        <section
          class="agent-activity-view__answer-section"
          role="region"
          aria-labelledby="answer-heading"
          aria-live="polite"
        >
          <div class="answer-card">
            <h3 id="answer-heading" class="answer-heading">
              <span class="answer-icon">‚ú®</span>
              Research Complete
            </h3>
            <div class="answer-content">
              @if (researchResult()?.answer) {
                <div class="answer-text" [innerHTML]="researchResult()!.answer"></div>
              } @else {
                <p class="answer-text">The research has been completed successfully.</p>
              }
            </div>
          </div>
        </section>
      }
    </div>
  }
</div>
